<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>NTI-AI v6 Signal Analyzer</title>
<script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/4.4.1/chart.umd.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/chartjs-chart-financial/0.1.1/chartjs-chart-financial.min.js"></script>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Share+Tech+Mono&family=Rajdhani:wght@400;600;700&display=swap');

  :root {
    --bg: #060a0f;
    --panel: #0b1118;
    --border: #1a2535;
    --bull: #00ff8c;
    --bear: #ff3c5a;
    --gold: #ffd700;
    --blue: #00c8ff;
    --text: #c8d8e8;
    --dim: #4a6070;
    --glow-bull: 0 0 12px rgba(0,255,140,0.4);
    --glow-bear: 0 0 12px rgba(255,60,90,0.4);
    --glow-gold: 0 0 12px rgba(255,215,0,0.35);
  }

  * { margin:0; padding:0; box-sizing:border-box; }

  body {
    background: var(--bg);
    color: var(--text);
    font-family: 'Rajdhani', sans-serif;
    font-size: 15px;
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Scanline overlay */
  body::before {
    content:'';
    position:fixed; inset:0;
    background: repeating-linear-gradient(0deg, transparent, transparent 2px, rgba(0,0,0,0.03) 2px, rgba(0,0,0,0.03) 4px);
    pointer-events:none; z-index:1000;
  }

  header {
    display:flex; align-items:center; justify-content:space-between;
    padding: 14px 24px;
    border-bottom: 1px solid var(--border);
    background: linear-gradient(90deg, #060a0f 0%, #0d1520 50%, #060a0f 100%);
    position:sticky; top:0; z-index:100;
  }

  .logo {
    font-family: 'Share Tech Mono', monospace;
    font-size: 18px;
    color: var(--gold);
    text-shadow: var(--glow-gold);
    letter-spacing: 2px;
  }
  .logo span { color: var(--bull); }

  .status-bar {
    display:flex; gap:20px; align-items:center;
    font-family: 'Share Tech Mono', monospace;
    font-size: 12px;
  }
  .status-dot {
    width:8px; height:8px; border-radius:50%;
    background: var(--bull);
    box-shadow: var(--glow-bull);
    animation: pulse 2s infinite;
  }
  @keyframes pulse { 0%,100%{opacity:1} 50%{opacity:0.4} }

  .controls {
    display:flex; gap:10px; align-items:center;
    flex-wrap:wrap;
    padding: 12px 24px;
    border-bottom: 1px solid var(--border);
    background: var(--panel);
  }

  .ctrl-group {
    display:flex; align-items:center; gap:8px;
  }
  .ctrl-label {
    font-size:12px; color:var(--dim); text-transform:uppercase; letter-spacing:1px;
  }

  select, input[type=text] {
    background: var(--bg);
    border: 1px solid var(--border);
    color: var(--text);
    padding: 6px 10px;
    font-family: 'Share Tech Mono', monospace;
    font-size: 13px;
    border-radius: 3px;
    outline:none;
    transition: border-color 0.2s;
  }
  select:focus, input:focus { border-color: var(--gold); }

  input[type=text] { width: 90px; }

  .btn {
    padding: 7px 18px;
    border: none; border-radius: 3px;
    font-family: 'Rajdhani', sans-serif;
    font-weight: 700; font-size: 14px;
    letter-spacing: 1px;
    cursor:pointer;
    transition: all 0.15s;
    text-transform: uppercase;
  }
  .btn-primary {
    background: var(--gold);
    color: #000;
    box-shadow: var(--glow-gold);
  }
  .btn-primary:hover { background:#ffe84d; transform:translateY(-1px); }
  .btn-primary:active { transform:translateY(0); }
  .btn-primary:disabled { background:#4a3e00; color:#8a7020; cursor:not-allowed; box-shadow:none; }

  .btn-sm {
    padding:4px 10px; font-size:12px;
    background:var(--border); color:var(--text); border:1px solid var(--dim);
    border-radius:2px; cursor:pointer; transition:all 0.15s;
  }
  .btn-sm:hover { border-color:var(--gold); color:var(--gold); }

  .main-grid {
    display:grid;
    grid-template-columns: 1fr 320px;
    grid-template-rows: auto 1fr;
    gap:0;
    height: calc(100vh - 105px);
  }

  .chart-panel {
    grid-column:1; grid-row:1/3;
    border-right: 1px solid var(--border);
    display:flex; flex-direction:column;
    position:relative;
  }

  .chart-header {
    display:flex; align-items:center; justify-content:space-between;
    padding: 10px 16px;
    border-bottom: 1px solid var(--border);
    background: var(--panel);
  }

  .ticker-display {
    font-family: 'Share Tech Mono', monospace;
    font-size: 20px; font-weight:700;
    color: var(--gold);
  }

  .price-display {
    font-family: 'Share Tech Mono', monospace;
    font-size: 22px;
  }
  .price-up { color: var(--bull); text-shadow: var(--glow-bull); }
  .price-dn { color: var(--bear); text-shadow: var(--glow-bear); }

  .chart-wrap {
    flex:1; position:relative; padding:8px;
    overflow:hidden;
  }

  canvas#mainChart { width:100% !important; }

  /* Signal overlays on chart */
  .signal-overlay {
    position:absolute; top:0; left:0; right:0; bottom:0;
    pointer-events:none;
  }

  /* Right panels */
  .side-top {
    grid-column:2; grid-row:1;
    border-bottom: 1px solid var(--border);
    overflow-y:auto;
  }
  .side-bottom {
    grid-column:2; grid-row:2;
    overflow-y:auto;
  }

  .panel-title {
    padding: 10px 14px;
    font-size:12px; font-weight:700;
    text-transform:uppercase; letter-spacing:2px;
    color: var(--dim);
    border-bottom: 1px solid var(--border);
    background: var(--panel);
    position:sticky; top:0; z-index:5;
  }
  .panel-title span { color:var(--gold); }

  /* Current signal card */
  .signal-card {
    margin:12px; padding:14px;
    border-radius:4px;
    border: 1px solid;
    animation: fadeIn 0.4s ease;
  }
  @keyframes fadeIn { from{opacity:0;transform:translateY(4px)} to{opacity:1;transform:none} }

  .signal-card.buy {
    background: rgba(0,255,140,0.06);
    border-color: var(--bull);
    box-shadow: var(--glow-bull);
  }
  .signal-card.sell {
    background: rgba(255,60,90,0.06);
    border-color: var(--bear);
    box-shadow: var(--glow-bear);
  }
  .signal-card.neutral {
    background: rgba(255,215,0,0.04);
    border-color: var(--dim);
  }

  .signal-type {
    font-family: 'Share Tech Mono', monospace;
    font-size:22px; font-weight:700;
    letter-spacing:3px; margin-bottom:6px;
  }
  .signal-type.buy  { color:var(--bull); text-shadow:var(--glow-bull); }
  .signal-type.sell { color:var(--bear); text-shadow:var(--glow-bear); }
  .signal-type.neutral { color:var(--dim); }

  .signal-reason {
    font-size:13px; line-height:1.5; color:var(--text);
    margin-top:8px;
  }

  .score-row {
    display:flex; justify-content:space-between;
    margin-top:10px; padding-top:8px;
    border-top:1px solid var(--border);
    font-family:'Share Tech Mono',monospace; font-size:12px;
  }
  .score-bull { color:var(--bull); }
  .score-bear { color:var(--bear); }

  .confidence-bar {
    margin-top:8px;
    height:4px; background:var(--border); border-radius:2px; overflow:hidden;
  }
  .confidence-fill {
    height:100%; border-radius:2px;
    transition: width 0.5s ease;
  }
  .confidence-fill.buy  { background: var(--bull); box-shadow:var(--glow-bull); }
  .confidence-fill.sell { background: var(--bear); box-shadow:var(--glow-bear); }

  /* History list */
  .history-list { padding:0; }

  .history-item {
    display:grid;
    grid-template-columns: 36px 1fr auto;
    gap:8px; align-items:center;
    padding: 9px 14px;
    border-bottom: 1px solid rgba(26,37,53,0.7);
    transition: background 0.15s;
    cursor:pointer;
    font-size:13px;
  }
  .history-item:hover { background: rgba(255,215,0,0.03); }

  .hist-badge {
    font-family:'Share Tech Mono',monospace;
    font-size:10px; font-weight:700;
    padding:3px 6px; border-radius:2px;
    text-align:center; letter-spacing:1px;
  }
  .hist-badge.buy  { background:rgba(0,255,140,0.15); color:var(--bull); border:1px solid rgba(0,255,140,0.3); }
  .hist-badge.sell { background:rgba(255,60,90,0.15);  color:var(--bear); border:1px solid rgba(255,60,90,0.3); }

  .hist-main { display:flex; flex-direction:column; gap:2px; }
  .hist-pattern { color:var(--text); font-weight:600; }
  .hist-time { font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--dim); }

  .hist-outcome {
    font-family:'Share Tech Mono',monospace; font-size:12px; font-weight:700;
    text-align:right;
  }
  .hist-outcome.win  { color:var(--bull); }
  .hist-outcome.loss { color:var(--bear); }
  .hist-outcome.open { color:var(--dim); }

  /* Stats bar */
  .stats-strip {
    display:flex; gap:0;
    border-top: 1px solid var(--border);
    background: var(--panel);
  }
  .stat-box {
    flex:1; padding:8px 12px;
    border-right:1px solid var(--border);
    text-align:center;
  }
  .stat-box:last-child { border-right:none; }
  .stat-val {
    font-family:'Share Tech Mono',monospace;
    font-size:16px; font-weight:700;
  }
  .stat-lbl { font-size:10px; color:var(--dim); text-transform:uppercase; letter-spacing:1px; margin-top:2px; }

  /* Loading overlay */
  #loadOverlay {
    position:absolute; inset:0;
    background:rgba(6,10,15,0.9);
    display:flex; flex-direction:column;
    align-items:center; justify-content:center;
    z-index:50;
    gap:12px;
  }
  .spinner {
    width:36px; height:36px;
    border:2px solid var(--border);
    border-top-color:var(--gold);
    border-radius:50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to{transform:rotate(360deg)} }
  .load-text {
    font-family:'Share Tech Mono',monospace;
    font-size:13px; color:var(--gold);
    letter-spacing:2px;
    animation:pulse 1.5s infinite;
  }

  /* Empty state */
  .empty-state {
    padding:24px 16px; text-align:center;
    color:var(--dim); font-size:13px; line-height:1.7;
  }
  .empty-state .big { font-size:28px; margin-bottom:8px; }

  /* Error */
  .error-msg {
    margin:12px; padding:12px;
    background:rgba(255,60,90,0.08);
    border:1px solid rgba(255,60,90,0.3);
    border-radius:4px;
    color:var(--bear); font-size:13px; line-height:1.5;
  }

  /* Indicator pills */
  .indicators {
    display:flex; flex-wrap:wrap; gap:5px; margin-top:10px;
  }
  .pill {
    font-family:'Share Tech Mono',monospace;
    font-size:10px; padding:2px 7px; border-radius:20px;
    border:1px solid;
  }
  .pill.bull { color:var(--bull); border-color:rgba(0,255,140,0.3); background:rgba(0,255,140,0.07); }
  .pill.bear { color:var(--bear); border-color:rgba(255,60,90,0.3);  background:rgba(255,60,90,0.07); }
  .pill.neu  { color:var(--dim);  border-color:var(--border); }

  /* Scrollbar */
  ::-webkit-scrollbar { width:4px; }
  ::-webkit-scrollbar-track { background:var(--bg); }
  ::-webkit-scrollbar-thumb { background:var(--border); border-radius:2px; }
  ::-webkit-scrollbar-thumb:hover { background:var(--dim); }

  @media (max-width: 768px) {
    .main-grid { grid-template-columns:1fr; grid-template-rows:auto auto auto; height:auto; }
    .chart-panel { grid-column:1; grid-row:1; height:55vw; min-height:260px; }
    .side-top, .side-bottom { grid-column:1; }
  }
</style>
</head>
<body>

<header>
  <div class="logo">NTI<span>-AI</span> v6 &nbsp;|&nbsp; SIGNAL ANALYZER</div>
  <div class="status-bar">
    <div class="status-dot"></div>
    <span id="statusText" style="color:var(--dim)">READY</span>
  </div>
</header>

<div class="controls">
  <div class="ctrl-group">
    <span class="ctrl-label">Symbol</span>
    <input type="text" id="symbolInput" value="BTC" placeholder="BTC, ETHâ€¦">
  </div>
  <div class="ctrl-group">
    <span class="ctrl-label">Timeframe</span>
    <select id="tfSelect">
      <option value="1d">Daily</option>
      <option value="4h">4 Hour</option>
      <option value="1h">1 Hour</option>
      <option value="15m">15 Min</option>
    </select>
  </div>
  <div class="ctrl-group">
    <span class="ctrl-label">Bars</span>
    <select id="barsSelect">
      <option value="30">30</option>
      <option value="60" selected>60</option>
      <option value="100">100</option>
    </select>
  </div>
  <button class="btn btn-primary" id="analyzeBtn" onclick="runAnalysis()">âš¡ Analyze</button>
  <div id="statsStrip" class="stats-strip" style="border:none; background:none; margin-left:auto; gap:16px;">
    <div class="stat-box" style="border:none; padding:0 8px;">
      <div class="stat-val" id="statWR" style="color:var(--gold)">â€”</div>
      <div class="stat-lbl">Win Rate</div>
    </div>
    <div class="stat-box" style="border:none; padding:0 8px;">
      <div class="stat-val" id="statSigs" style="color:var(--blue)">â€”</div>
      <div class="stat-lbl">Signals</div>
    </div>
    <div class="stat-box" style="border:none; padding:0 8px;">
      <div class="stat-val" id="statBuys" style="color:var(--bull)">â€”</div>
      <div class="stat-lbl">Buys</div>
    </div>
    <div class="stat-box" style="border:none; padding:0 8px;">
      <div class="stat-val" id="statSells" style="color:var(--bear)">â€”</div>
      <div class="stat-lbl">Sells</div>
    </div>
  </div>
</div>

<div class="main-grid">

  <!-- Chart -->
  <div class="chart-panel">
    <div class="chart-header">
      <div class="ticker-display" id="chartTicker">â€”</div>
      <div id="chartPrice" class="price-display">â€”</div>
    </div>
    <div class="chart-wrap" id="chartWrap">
      <canvas id="mainChart"></canvas>
      <div id="loadOverlay">
        <div style="font-size:32px">ðŸ“Š</div>
        <div class="load-text">ENTER SYMBOL & ANALYZE</div>
      </div>
    </div>
  </div>

  <!-- Current Signal -->
  <div class="side-top">
    <div class="panel-title">Current <span>Signal</span></div>
    <div id="currentSignal">
      <div class="empty-state">
        <div class="big">ðŸ¤–</div>
        Run analysis to see<br>the current signal
      </div>
    </div>
  </div>

  <!-- History -->
  <div class="side-bottom">
    <div class="panel-title">Signal <span>History</span></div>
    <div id="historyList">
      <div class="empty-state">
        <div class="big">ðŸ“œ</div>
        Historical signals will<br>appear here
      </div>
    </div>
  </div>

</div>

<script>
// â”€â”€â”€ State â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
let chartInstance = null;
let allSignals    = [];
let candles       = [];

// â”€â”€â”€ Simulated OHLCV data generator (realistic random walk) â”€â”€â”€
function generateCandles(symbol, bars) {
  // Seed prices per symbol so repeated runs are consistent
  const seeds = { BTC:65000, ETH:3200, SOL:170, AAPL:195, SPY:520, NVDA:880, GOLD:2350, EUR:1.08 };
  let price = seeds[symbol.toUpperCase()] || 100;
  const volatility = price > 10000 ? 0.022 : price > 1000 ? 0.018 : price > 100 ? 0.015 : 0.012;

  const now = Date.now();
  const msPerBar = 24*60*60*1000; // daily default
  const data = [];

  // Seed for reproducibility
  let seed = symbol.split('').reduce((a,c)=>a+c.charCodeAt(0),0);
  function rand() { seed = (seed * 1664525 + 1013904223) & 0xffffffff; return (seed >>> 0) / 4294967296; }

  for (let i = bars; i >= 0; i--) {
    const t = now - i * msPerBar;
    const change = (rand() - 0.48) * volatility;
    price = Math.max(price * (1 + change), 0.01);

    const bodyPct = 0.3 + rand() * 0.6;
    const open  = price * (1 + (rand()-0.5)*0.008);
    const close = open * (1 + (rand()-0.5)*volatility*1.2);
    const high  = Math.max(open,close) * (1 + rand()*volatility*0.5);
    const low   = Math.min(open,close) * (1 - rand()*volatility*0.5);
    const vol   = 1000 + rand()*5000;

    data.push({ t, o:open, h:high, l:low, c:close, v:vol });
  }
  return data;
}

// â”€â”€â”€ Pattern detection (client-side, fast) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function detectPatterns(candles, idx) {
  const patterns = [];
  const c = candles;
  const i = idx;
  if (i < 2) return patterns;

  const body = (x) => Math.abs(x.c - x.o);
  const rng  = (x) => x.h - x.l;
  const upper= (x) => x.h - Math.max(x.o,x.c);
  const lower= (x) => Math.min(x.o,x.c) - x.l;
  const isBull=(x) => x.c > x.o;
  const isBear=(x) => x.c < x.o;
  const isDoji=(x) => body(x) <= rng(x) * 0.06;

  const cur = c[i], p1 = c[i-1], p2 = i>=2?c[i-2]:null;

  // Hammer
  if (lower(cur)>=body(cur)*2.2 && upper(cur)<=body(cur)*0.4 && isBull(cur))
    patterns.push({name:'Hammer', dir:'bull', score:6});
  // Shooting star
  if (upper(cur)>=body(cur)*2.2 && lower(cur)<=body(cur)*0.4 && isBear(cur))
    patterns.push({name:'Shooting Star', dir:'bear', score:6});
  // Bullish engulfing
  if (isBull(cur) && cur.c>p1.h && cur.o<p1.l && isBear(p1))
    patterns.push({name:'Bullish Engulfing', dir:'bull', score:9});
  // Bearish engulfing
  if (isBear(cur) && cur.c<p1.l && cur.o>p1.h && isBull(p1))
    patterns.push({name:'Bearish Engulfing', dir:'bear', score:9});
  // Doji
  if (isDoji(cur))
    patterns.push({name:'Doji', dir:'neu', score:3});
  // Morning star
  if (p2 && isBear(p2) && body(p1)<body(p2)*0.35 && isBull(cur) && cur.c>(p2.h+p2.l)/2)
    patterns.push({name:'Morning Star', dir:'bull', score:11});
  // Evening star
  if (p2 && isBull(p2) && body(p1)<body(p2)*0.35 && isBear(cur) && cur.c<(p2.h+p2.l)/2)
    patterns.push({name:'Evening Star', dir:'bear', score:11});
  // Three white soldiers
  if (p2 && isBull(cur)&&isBull(p1)&&isBull(p2)&&cur.c>p1.c&&p1.c>p2.c)
    patterns.push({name:'3 White Soldiers', dir:'bull', score:8});
  // Three black crows
  if (p2 && isBear(cur)&&isBear(p1)&&isBear(p2)&&cur.c<p1.c&&p1.c<p2.c)
    patterns.push({name:'3 Black Crows', dir:'bear', score:8});
  // Harami bull
  if (isBull(cur)&&cur.h<p1.h&&cur.l>p1.l&&isBear(p1))
    patterns.push({name:'Bullish Harami', dir:'bull', score:5});
  // Harami bear
  if (isBear(cur)&&cur.h<p1.h&&cur.l>p1.l&&isBull(p1))
    patterns.push({name:'Bearish Harami', dir:'bear', score:5});
  // Marubozu bull
  if (isBull(cur)&&body(cur)>=rng(cur)*0.92)
    patterns.push({name:'Bullish Marubozu', dir:'bull', score:6});
  // Marubozu bear
  if (isBear(cur)&&body(cur)>=rng(cur)*0.92)
    patterns.push({name:'Bearish Marubozu', dir:'bear', score:6});
  // Tweezer bottom
  if (isBear(p1)&&isBull(cur)&&Math.abs(cur.l-p1.l)<rng(cur)*0.08)
    patterns.push({name:'Tweezer Bottom', dir:'bull', score:6});
  // Tweezer top
  if (isBull(p1)&&isBear(cur)&&Math.abs(cur.h-p1.h)<rng(cur)*0.08)
    patterns.push({name:'Tweezer Top', dir:'bear', score:6});
  // Piercing line
  if (isBear(p1)&&isBull(cur)&&cur.o<p1.l&&cur.c>(p1.h+p1.l)/2)
    patterns.push({name:'Piercing Line', dir:'bull', score:7});
  // Dark cloud
  if (isBull(p1)&&isBear(cur)&&cur.o>p1.h&&cur.c<(p1.h+p1.l)/2)
    patterns.push({name:'Dark Cloud Cover', dir:'bear', score:7});

  return patterns;
}

function computeIndicators(candles, idx) {
  // RSI-14
  function rsi(arr, period=14) {
    if(arr.length < period+1) return 50;
    let gains=0,losses=0;
    for(let j=arr.length-period;j<arr.length;j++){
      const d=arr[j].c-arr[j-1].c;
      if(d>0) gains+=d; else losses-=d;
    }
    const rs=gains/Math.max(losses,0.0001);
    return 100-100/(1+rs);
  }
  // SMA
  function sma(arr,p,key='c'){
    if(arr.length<p)return arr[arr.length-1][key];
    return arr.slice(-p).reduce((a,x)=>a+x[key],0)/p;
  }
  // EMA
  function ema(arr,p,key='c'){
    if(arr.length<p)return arr[arr.length-1][key];
    let e=arr.slice(0,p).reduce((a,x)=>a+x[key],0)/p;
    const k=2/(p+1);
    for(let j=p;j<arr.length;j++) e=arr[j][key]*k+e*(1-k);
    return e;
  }
  // Volume spike
  const slice = candles.slice(0, idx+1);
  const avgVol = sma(slice,20,'v');
  const volSpike = slice[slice.length-1].v > avgVol*1.8;

  const rsiVal  = rsi(slice);
  const ema8    = ema(slice,8);
  const ema21   = ema(slice,21);
  const ema55   = ema(slice,55);
  const cur     = slice[slice.length-1];
  const trendUp = cur.c > ema8 && ema8 > ema21 && ema21 > ema55;
  const trendDn = cur.c < ema8 && ema8 < ema21 && ema21 < ema55;

  // BB
  const mean = sma(slice,20);
  const std  = Math.sqrt(slice.slice(-20).reduce((a,x)=>a+Math.pow(x.c-mean,2),0)/20);
  const bbUp = mean+2*std, bbLo=mean-2*std;
  const bbSq = (bbUp-bbLo) < (sma(slice.slice(0,-1),20)+sma(slice.slice(0,-1),20))*0.8;

  // Swing high/low
  const lookback = Math.min(20, slice.length-1);
  let swingH=0,swingL=Infinity;
  for(let j=slice.length-1-lookback;j<slice.length-1;j++){
    swingH=Math.max(swingH,slice[j].h);
    swingL=Math.min(swingL,slice[j].l);
  }
  const bos_bull = cur.h > swingH && cur.c > swingH;
  const bos_bear = cur.l < swingL && cur.c < swingL;

  return { rsiVal, ema8, ema21, ema55, trendUp, trendDn, volSpike, bbUp, bbLo, bbSq, bos_bull, bos_bear, mean };
}

function scoreCandle(candles, idx) {
  if(idx < 3) return {dir:'neutral', score:0, bullScore:0, bearScore:0, patterns:[], indicators:{}};

  const patterns = detectPatterns(candles, idx);
  const ind = computeIndicators(candles, idx);

  let bullScore = 0, bearScore = 0;

  // Pattern scores
  patterns.forEach(p => {
    if(p.dir==='bull') bullScore += p.score;
    else if(p.dir==='bear') bearScore += p.score;
  });

  // Indicator scores
  if(ind.rsiVal < 30) bullScore += 6;
  if(ind.rsiVal > 70) bearScore += 6;
  if(ind.rsiVal < 20) bullScore += 4;
  if(ind.rsiVal > 80) bearScore += 4;
  if(ind.trendUp) bullScore = bullScore*1.3;
  if(ind.trendDn) bearScore = bearScore*1.3;
  if(ind.volSpike) { bullScore*=1.2; bearScore*=1.2; }
  if(ind.bos_bull) bullScore += 10;
  if(ind.bos_bear) bearScore += 10;
  if(candles[idx].c < ind.bbLo) bullScore += 5;
  if(candles[idx].c > ind.bbUp) bearScore += 5;

  const minScore = 8;
  let dir = 'neutral';
  if(bullScore > bearScore && bullScore >= minScore) dir = 'buy';
  else if(bearScore > bullScore && bearScore >= minScore) dir = 'sell';

  return { dir, score: Math.max(bullScore,bearScore), bullScore, bearScore, patterns, indicators:ind };
}

// â”€â”€â”€ Determine outcome for historical signals â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function computeOutcome(candles, idx, dir) {
  if(idx >= candles.length-4) return 'open';
  const entry = candles[idx].c;
  const atr   = candles.slice(Math.max(0,idx-14),idx).reduce((a,c)=>a+(c.h-c.l),0)/14;
  const tp    = dir==='buy' ? entry+atr*2 : entry-atr*2;
  const sl    = dir==='buy' ? entry-atr*1.2 : entry+atr*1.2;

  for(let j=idx+1; j<=Math.min(idx+10, candles.length-1); j++) {
    if(dir==='buy') {
      if(candles[j].h >= tp) return 'win';
      if(candles[j].l <= sl) return 'loss';
    } else {
      if(candles[j].l <= tp) return 'win';
      if(candles[j].h >= sl) return 'loss';
    }
  }
  // After 10 bars, check direction
  const finalPrice = candles[Math.min(idx+10, candles.length-1)].c;
  if(dir==='buy')  return finalPrice > entry ? 'win' : 'loss';
  return finalPrice < entry ? 'win' : 'loss';
}

// â”€â”€â”€ Build chart â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
function buildChart(candles, signals) {
  const ctx = document.getElementById('mainChart').getContext('2d');
  if(chartInstance) { chartInstance.destroy(); chartInstance=null; }

  const labels = candles.map(c => new Date(c.t).toLocaleDateString('en-US',{month:'short',day:'numeric'}));

  // OHLC bars as separate up/down datasets
  const upBodies=[], dnBodies=[], upWicks=[], dnWicks=[], upBorderColor=[], dnBorderColor=[];
  const bullC='rgba(0,255,140,0.85)', bearC='rgba(255,60,90,0.85)';
  const bullW='rgba(0,255,140,0.5)',  bearW='rgba(255,60,90,0.5)';

  // Build floating bar data for candle bodies
  const bodyData = candles.map(c => ({
    x: labels[candles.indexOf(c)],
    y: [Math.min(c.o,c.c), Math.max(c.o,c.c)],
    isBull: c.c >= c.o
  }));

  // Wick lines as error bars approximation â€” use scatter
  const wickData = candles.map(c => ({
    x: labels[candles.indexOf(c)],
    y: (c.h+c.l)/2,
    high: c.h,
    low: c.l
  }));

  // Signal markers
  const buyPoints  = candles.map((c,i) => signals[i]?.dir==='buy'  ? c.l*0.994 : null);
  const sellPoints = candles.map((c,i) => signals[i]?.dir==='sell' ? c.h*1.006 : null);

  chartInstance = new Chart(ctx, {
    type: 'bar',
    data: {
      labels,
      datasets: [
        {
          label: 'Candle',
          data: bodyData.map(d=>d.y),
          backgroundColor: bodyData.map(d=>d.isBull ? 'rgba(0,255,140,0.75)' : 'rgba(255,60,90,0.75)'),
          borderColor:     bodyData.map(d=>d.isBull ? '#00ff8c' : '#ff3c5a'),
          borderWidth:1,
          borderSkipped:false,
        },
        {
          label: 'BUY Signal',
          type: 'scatter',
          data: buyPoints.map((v,i)=> v!==null ? {x:labels[i],y:v} : null).filter(Boolean),
          backgroundColor: '#00ff8c',
          pointStyle: 'triangle',
          radius:8,
          pointBackgroundColor:'#00ff8c',
        },
        {
          label: 'SELL Signal',
          type: 'scatter',
          data: sellPoints.map((v,i)=> v!==null ? {x:labels[i],y:v*1.012} : null).filter(Boolean),
          backgroundColor: '#ff3c5a',
          pointStyle: 'triangle',
          rotation:180,
          radius:8,
          pointBackgroundColor:'#ff3c5a',
        }
      ]
    },
    options: {
      responsive:true, maintainAspectRatio:false,
      animation:{ duration:400 },
      plugins:{
        legend:{ display:false },
        tooltip:{
          mode:'index', intersect:false,
          backgroundColor:'rgba(11,17,24,0.95)',
          borderColor:'rgba(255,215,0,0.3)', borderWidth:1,
          titleColor:'#ffd700', bodyColor:'#c8d8e8',
          titleFont:{family:"'Share Tech Mono'",size:11},
          bodyFont:{family:"'Share Tech Mono'",size:11},
          callbacks:{
            title: (items)=>labels[items[0].dataIndex],
            label: (item)=>{
              const c=candles[item.dataIndex];
              if(!c)return '';
              const fmt=v=>v>=1?v.toFixed(2):v.toFixed(4);
              const s=signals[item.dataIndex];
              const sig=s?.dir!=='neutral'?(` | ${s.dir.toUpperCase()} (${s.score.toFixed(0)})`): '';
              return ` O:${fmt(c.o)} H:${fmt(c.h)} L:${fmt(c.l)} C:${fmt(c.c)}${sig}`;
            }
          }
        }
      },
      scales:{
        x:{
          ticks:{color:'#4a6070',font:{size:10,family:"'Share Tech Mono'"},maxTicksLimit:10},
          grid:{color:'rgba(26,37,53,0.5)'},
        },
        y:{
          ticks:{color:'#4a6070',font:{size:10,family:"'Share Tech Mono'"},
            callback:v=>v>=1?v.toFixed(0):v.toFixed(4)},
          grid:{color:'rgba(26,37,53,0.5)'},
          position:'right',
        }
      }
    }
  });
}

// â”€â”€â”€ Ask AI for narrative analysis â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function getAIAnalysis(symbol, currentCandle, result) {
  const patternNames = result.patterns.map(p=>p.name).join(', ') || 'No strong patterns';
  const prompt = `You are a professional candlestick analyst for ${symbol}. 
Current candle: Open ${currentCandle.o.toFixed(2)}, High ${currentCandle.h.toFixed(2)}, Low ${currentCandle.l.toFixed(2)}, Close ${currentCandle.c.toFixed(2)}.
Patterns detected: ${patternNames}
Bull score: ${result.bullScore.toFixed(1)}, Bear score: ${result.bearScore.toFixed(1)}
RSI: ${result.indicators.rsiVal?.toFixed(1)}, Trend: ${result.indicators.trendUp?'UP':result.indicators.trendDn?'DOWN':'MIXED'}
Signal: ${result.dir.toUpperCase()}

Give a 2-sentence trading analysis explaining WHY this signal was triggered and what to watch for. Be specific and concise. No disclaimers.`;

  try {
    const resp = await fetch("https://api.anthropic.com/v1/messages", {
      method:"POST",
      headers:{"Content-Type":"application/json"},
      body: JSON.stringify({
        model:"claude-sonnet-4-20250514",
        max_tokens:1000,
        messages:[{role:"user",content:prompt}]
      })
    });
    const data = await resp.json();
    return data.content?.[0]?.text || '';
  } catch(e) { return ''; }
}

// â”€â”€â”€ Main analysis runner â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
async function runAnalysis() {
  const symbol  = document.getElementById('symbolInput').value.trim().toUpperCase() || 'BTC';
  const bars    = parseInt(document.getElementById('barsSelect').value);
  const btn     = document.getElementById('analyzeBtn');

  btn.disabled = true;
  btn.textContent = 'Analyzingâ€¦';
  document.getElementById('statusText').textContent = 'SCANNING';
  document.getElementById('statusText').style.color = 'var(--gold)';

  // Show loading overlay on chart
  const overlay = document.getElementById('loadOverlay');
  overlay.style.display = 'flex';
  overlay.innerHTML = `<div class="spinner"></div><div class="load-text">SCANNING ${symbol}â€¦</div>`;

  candles = generateCandles(symbol, bars);

  // Score every bar
  allSignals = candles.map((_,i) => scoreCandle(candles, i));

  // Compute outcomes for historical signals
  const signalHistory = [];
  allSignals.forEach((s,i) => {
    if(s.dir !== 'neutral') {
      const outcome = computeOutcome(candles, i, s.dir);
      signalHistory.push({ idx:i, ...s, outcome,
        candle: candles[i],
        date: new Date(candles[i].t).toLocaleDateString('en-US',{month:'short',day:'numeric'})
      });
    }
  });

  // Build chart
  buildChart(candles, allSignals);
  overlay.style.display = 'none';

  // Update ticker / price
  const last = candles[candles.length-1];
  const prev = candles[candles.length-2];
  document.getElementById('chartTicker').textContent = symbol;
  const pct = ((last.c-prev.c)/prev.c*100);
  const priceEl = document.getElementById('chartPrice');
  priceEl.textContent = `${last.c>=1?last.c.toFixed(2):last.c.toFixed(4)} (${pct>=0?'+':''}${pct.toFixed(2)}%)`;
  priceEl.className = 'price-display ' + (last.c>=prev.c ? 'price-up' : 'price-dn');

  // Stats
  const wins   = signalHistory.filter(s=>s.outcome==='win').length;
  const closed = signalHistory.filter(s=>s.outcome!=='open').length;
  const buys   = signalHistory.filter(s=>s.dir==='buy').length;
  const sells  = signalHistory.filter(s=>s.dir==='sell').length;
  const wr     = closed > 0 ? Math.round(wins/closed*100) : 0;

  document.getElementById('statWR').textContent   = closed>0 ? `${wr}%` : 'â€”';
  document.getElementById('statWR').style.color   = wr>=55?'var(--bull)':wr<45?'var(--bear)':'var(--gold)';
  document.getElementById('statSigs').textContent = signalHistory.length;
  document.getElementById('statBuys').textContent  = buys;
  document.getElementById('statSells').textContent = sells;

  // Current signal card
  const cur = allSignals[allSignals.length-1];
  renderCurrentSignal(cur, last, symbol);

  // History list
  renderHistory(signalHistory);

  btn.disabled = false;
  btn.textContent = 'âš¡ Analyze';
  document.getElementById('statusText').textContent = 'LIVE';
  document.getElementById('statusText').style.color = 'var(--bull)';
}

function renderCurrentSignal(result, candle, symbol) {
  const el = document.getElementById('currentSignal');
  const dir = result.dir;
  const conf = Math.min(99, Math.round(result.score / 40 * 100));
  const patternList = result.patterns.filter(p=>p.dir!=='neu');

  const pillsHtml = patternList.slice(0,5).map(p=>
    `<span class="pill ${p.dir}">${p.name}</span>`
  ).join('');

  const indHtml = result.indicators ? `
    <div style="margin-top:8px; font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--dim); display:flex; gap:12px; flex-wrap:wrap;">
      <span>RSI <span style="color:${result.indicators.rsiVal<30?'var(--bull)':result.indicators.rsiVal>70?'var(--bear)':'var(--text)'}">${result.indicators.rsiVal?.toFixed(0)}</span></span>
      <span>Trend <span style="color:${result.indicators.trendUp?'var(--bull)':result.indicators.trendDn?'var(--bear)':'var(--dim)'}">${result.indicators.trendUp?'â†‘UP':result.indicators.trendDn?'â†“DN':'â€”'}</span></span>
      <span>Vol <span style="color:${result.indicators.volSpike?'var(--gold)':'var(--dim)'}">${result.indicators.volSpike?'SPIKE':'NORM'}</span></span>
    </div>` : '';

  if(dir==='neutral') {
    el.innerHTML = `
      <div class="signal-card neutral">
        <div class="signal-type neutral">NEUTRAL</div>
        <div class="signal-reason">No strong pattern detected on the current bar. Wait for a clearer setup before entering a trade.</div>
        ${indHtml}
        <div class="indicators">${pillsHtml}</div>
      </div>`;
    return;
  }

  const dirLabel = dir==='buy' ? 'â¬† BUY' : 'â¬‡ SELL';
  el.innerHTML = `
    <div class="signal-card ${dir}">
      <div class="signal-type ${dir}">${dirLabel}</div>
      <div style="font-family:'Share Tech Mono',monospace; font-size:11px; color:var(--dim);">
        Score: <span style="color:var(--text)">${result.score.toFixed(1)}</span> &nbsp;|&nbsp;
        Bull: <span class="score-bull">${result.bullScore.toFixed(1)}</span> &nbsp;|&nbsp;
        Bear: <span class="score-bear">${result.bearScore.toFixed(1)}</span>
      </div>
      <div class="confidence-bar">
        <div class="confidence-fill ${dir}" style="width:${Math.min(conf,100)}%"></div>
      </div>
      <div style="font-family:'Share Tech Mono',monospace;font-size:10px;color:var(--dim);margin-top:3px;">Confidence: ${conf}%</div>
      <div id="aiReasoning" class="signal-reason" style="color:var(--dim);font-style:italic;font-size:12px;">Loading AI analysisâ€¦</div>
      <div class="indicators">${pillsHtml||`<span class="pill neu">Indicator-driven</span>`}</div>
      ${indHtml}
    </div>`;

  // Async AI reasoning
  getAIAnalysis(symbol, candle, result).then(text => {
    const el2 = document.getElementById('aiReasoning');
    if(el2 && text) { el2.textContent = text; el2.style.color='var(--text)'; el2.style.fontStyle='normal'; }
    else if(el2)    { el2.textContent = `${patternList[0]?.name||'Indicator confluence'} signal. Score: ${result.score.toFixed(0)}.`; el2.style.color='var(--text)'; el2.style.fontStyle='normal'; }
  });
}

function renderHistory(history) {
  const el = document.getElementById('historyList');
  if(!history.length) {
    el.innerHTML='<div class="empty-state"><div class="big">ðŸ“­</div>No signals found<br>in this range</div>';
    return;
  }

  // Show newest first
  const reversed = [...history].reverse();
  el.innerHTML = `<div class="history-list">` + reversed.map(s => {
    const topPattern = s.patterns.filter(p=>p.dir!=='neu').sort((a,b)=>b.score-a.score)[0];
    const pName = topPattern?.name || 'Indicator Signal';
    const outcomeClass = s.outcome==='win'?'win':s.outcome==='loss'?'loss':'open';
    const outcomeLabel = s.outcome==='win'?'âœ“ WIN':s.outcome==='loss'?'âœ— LOSS':'â— OPEN';
    const price = s.candle.c >= 1 ? s.candle.c.toFixed(2) : s.candle.c.toFixed(4);
    return `
      <div class="history-item" onclick="jumpToBar(${s.idx})">
        <div class="hist-badge ${s.dir}">${s.dir.toUpperCase()}</div>
        <div class="hist-main">
          <div class="hist-pattern">${pName}</div>
          <div class="hist-time">${s.date} &nbsp;@ ${price} &nbsp;Score:${s.score.toFixed(0)}</div>
        </div>
        <div class="hist-outcome ${outcomeClass}">${outcomeLabel}</div>
      </div>`;
  }).join('') + `</div>`;
}

function jumpToBar(idx) {
  // Highlight the bar in chart by updating tooltip
  if(!chartInstance) return;
  chartInstance.tooltip.setActiveElements([{datasetIndex:0,index:idx}],{x:0,y:0});
  chartInstance.update();
}

// Auto-run on load with BTC
window.addEventListener('load', ()=> setTimeout(runAnalysis, 300));
</script>
</body>
</html>
